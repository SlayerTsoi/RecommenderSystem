<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CineMatch - Intelligent Movie Recommendations</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
            min-height: 100vh;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 3px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: #6366f1;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .navbar {
            background: var(--primary-gradient);
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.1);
        }

        .movie-card {
            background: white;
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            cursor: pointer;
            margin-bottom: 1.5rem;
        }

        .movie-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .movie-poster {
            height: 320px;
            background: #e5e7eb;
            position: relative;
        }

        .movie-poster img {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }

        .movie-poster::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white !important;
            border: none;
            transition: transform 0.2s ease;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            opacity: 0.95;
        }

        .section-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .genre-tag {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .checked-star {
            color: #f59e0b !important;
        }
    </style>
</head>
<body>
<div id="app">
    <template v-if="isLoading">
        <section class="hero is-fullheight">
            <div class="hero-body has-text-centered">
                <div class="loader"></div>
                <p class="mt-4 has-text-grey">Analyzing your preferences...</p>
            </div>
        </section>
    </template>

    <template v-else>
        <nav class="navbar is-fixed-top">
            <div class="container">
                <div class="navbar-brand">
                    <a class="navbar-item has-text-white has-text-weight-bold is-size-5">
                        ðŸŽ¬ CineMatch
                    </a>
                </div>

                <div class="navbar-menu">
                    <div class="navbar-end">
                        <div class="navbar-item">
                            <div class="buttons">
                                <button class="button is-light" @click="cleanAll">
                                    <span class="icon"><i class="fas fa-redo"></i></span>
                                    <span>Reset</span>
                                </button>
                                <button class="button is-light" @click="showGenres = true">
                                    <span class="icon"><i class="fas fa-filter"></i></span>
                                    <span>Genres</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <main class="section" style="margin-top: 80px;">
            {% if recommendations %}
            <section class="mb-6">
                <div class="container">
                    <div class="section-header">
                        <h2 class="title is-4 has-text-weight-semibold">Recommended For You</h2>
                        <p class="subtitle is-6 has-text-grey">{{ recommendations_message }}</p>
                    </div>
                    <div class="columns is-multiline is-variable is-4">
                        {% for movie in recommendations %}
                        <div class="column is-3">
                            <div class="movie-card">
                                <div class="movie-poster">
                                    <img src="{{ movie['cover_url'] }}" 
                                         onerror="this.src='https://placehold.co/400x600?text=No+Poster'">
                                </div>
                                <div class="p-4">
                                    <h3 class="has-text-weight-semibold mb-2">{{ movie['title'] }}</h3>
                                    <div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
                                        <span class="tag is-primary">{{ movie['release_date'] }}</span>
                                        <div class="star-rating">
                                            {% for i in range(5) %}
                                            <span class="icon has-text-warning">
                                                <i class="fas fa-star"></i>
                                            </span>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <button class="button btn-primary is-fullwidth" 
                                            @click="updateLike({{movie['movieId']}})">
                                        <span class="icon">
                                            <i :class="inLikes({{movie['movieId']}}) ? 'fas fa-heart' : 'far fa-heart'"></i>
                                        </span>
                                        <span>[[ inLikes({{movie['movieId']}}) ? 'Liked' : 'Add to Favorites' ]]</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% endif %}

            {% if likes_similars %}
            <section class="mb-6">
                <div class="container">
                    <div class="section-header">
                        <h2 class="title is-4 has-text-weight-semibold">Similar to Your Likes</h2>
                        <p class="subtitle is-6 has-text-grey">{{ likes_similar_message }}</p>
                    </div>
                    <div class="columns is-multiline is-variable is-4">
                        {% for movie in likes_similars %}
                        <div class="column is-2">
                            <div class="movie-card">
                                <div class="movie-poster">
                                    <img src="{{ movie['cover_url'] }}" 
                                         onerror="this.src='https://placehold.co/400x600?text=No+Poster'">
                                </div>
                                <div class="p-3">
                                    <h3 class="has-text-weight-semibold mb-1 is-size-7">{{ movie['title'] }}</h3>
                                    <div class="is-flex is-justify-content-space-between is-align-items-center">
                                        <span class="tag is-primary is-light is-size-7">{{ movie['release_date'] }}</span>
                                        <button class="button is-small is-primary is-rounded" 
                                                @click="updateLike({{movie['movieId']}})">
                                            <span class="icon is-small">
                                                <i :class="inLikes({{movie['movieId']}}) ? 'fas fa-heart' : 'far fa-heart'"></i>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% endif %}

            {% if likes %}
            <section class="mb-6">
                <div class="container">
                    <div class="section-header">
                        <h2 class="title is-4 has-text-weight-semibold">Your Favorites</h2>
                        <div class="buttons">
                            <button class="button is-small is-primary" @click="reloadPage">
                                <span class="icon"><i class="fas fa-sync"></i></span>
                                <span>Refresh</span>
                            </button>
                        </div>
                    </div>
                    <div class="columns is-multiline is-variable is-2">
                        {% for movie in likes %}
                        <div class="column is-2">
                            <div class="movie-card">
                                <div class="movie-poster">
                                    <img src="{{ movie['cover_url'] }}" 
                                         onerror="this.src='https://placehold.co/400x600?text=No+Poster'">
                                </div>
                                <div class="p-3">
                                    <h3 class="has-text-weight-semibold mb-1 is-size-7">{{ movie['title'] }}</h3>
                                    <div class="is-flex is-justify-content-space-between is-align-items-center">
                                        <span class="tag is-primary is-light is-size-7">{{ movie['release_date'] }}</span>
                                        <button class="button is-small is-danger is-rounded" 
                                                @click="updateLike({{movie['movieId']}})">
                                            <span class="icon is-small">
                                                <i class="fas fa-times"></i>
                                            </span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </section>
            {% endif %}
        </main>

        <footer class="footer py-5 has-background-white">
            <div class="content has-text-centered">
                <p class="has-text-grey">
                    Â© 2023 CineMatch - Intelligent Movie Recommendations<br>
                    Powered by Machine Learning Algorithms
                </p>
            </div>
        </footer>

        <div :class="['modal', showGenres ? 'is-active' : '']">
            <div class="modal-background"></div>
            <div class="modal-card">
                <header class="modal-card-head">
                    <p class="modal-card-title">Select Your Favorite Genres</p>
                    <button class="delete" @click="showGenres = false"></button>
                </header>
                <div class="modal-card-body">
                    <div class="field is-grouped is-grouped-multiline">
                        {% for gener in genres %}
                        <div class="control">
                            <button :class="['button is-rounded genre-tag', inGenres({{gener['id']}}) ? 'btn-primary' : '']" 
                                    @click="updateGenre({{gener['id']}})">
                                {{gener['name']}}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <footer class="modal-card-foot">
                    <button class="button btn-primary" @click="saveGenres">
                        Save Preferences
                    </button>
                </footer>
            </div>
        </div>

        <div :class="['modal', showMovieRate ? 'is-active' : '']">
            <div class="modal-background"></div>
            <div class="modal-card" style="max-width: 1000px">
                <header class="modal-card-head">
                    <p class="modal-card-title">Rate Movies to Improve Recommendations</p>
                    <button class="delete" @click="showMovieRate = false"></button>
                </header>
                <div class="modal-card-body">
                    <div class="columns is-multiline">
                        {% for movie in default_genres_movies %}
                        <div class="column is-3">
                            <div class="movie-card">
                                <div class="movie-poster">
                                    <img src="{{ movie['cover_url'] }}" 
                                         onerror="this.src='https://placehold.co/400x600?text=No+Poster'">
                                </div>
                                <div class="p-3">
                                    <h3 class="has-text-weight-semibold mb-2 is-size-7">{{ movie['title'] }}</h3>
                                    <div class="star-rating has-text-centered">
                                        {% for rate in [1,2,3,4,5] %}
                                        <span class="icon is-clickable" 
                                              @click="updateRate({{movie['movieId']}}, {{rate}})">
                                            <i :class="['fas fa-star', getRate({{movie['movieId']}})[1] >= {{rate}} ? 'checked-star' : 'has-text-grey-light']"></i>
                                        </span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <footer class="modal-card-foot">
                    <button class="button btn-primary" @click="showMovieRate = false; reloadPage()">
                        Save Ratings
                    </button>
                </footer>
            </div>
        </div>
    </template>
</div>

<script type="module">
    import {createApp, onMounted, ref} from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'

    let app = createApp({
        setup() {
            const isLoading = ref(true)
            const isActivityNavBar = ref(false)

            // ==== Vue default operations ====
            onMounted(() => {
                isLoading.value = false

                showGenres.value = genres.value.length === 0
                showMovieRate.value = (genres.value.length > 0 && userRates.value.length === 0)
            })

            function cleanAll() {
                if (confirm("Are you sure to delete all records?")) {
                    document.cookie = "user_genres=; Max-Age=0";
                    document.cookie = "user_rates=; Max-Age=0";
                    document.cookie = "user_likes=; Max-Age=0";
                    reloadPage()
                }
            }

            // ==== Genre Operation ====
            const showGenres = ref(false)
            const genres = ref({{user_genres | tojson}}) // If this place shows error, please check the format: ref({{user_genres | tojson}})

            function updateGenre(_id) {
                let id = _id.toString()
                const index = genres.value.indexOf(id);
                if (index > -1) {
                    genres.value.splice(index, 1);
                } else {
                    genres.value.push(id);
                    genres.value = genres.value.sort(function (a, b) {
                        return a - b;
                    });
                }
            }

            function inGenres(id) {
                return genres.value.includes(id.toString())
            }

            function saveGenres() {
                document.cookie = "user_genres=" + genres.value;
                document.cookie = "user_rates=; Max-Age=0";
                reloadPage()
            }

            // ==== Movie Rate Operation ====
            const showMovieRate = ref(false)
            const userRates = ref({{user_rates | tojson}}) // If this place shows error, please check the format: ref({{user_rates | tojson}})

            function getRate(movieId) {
                for (let index in userRates.value) {
                    let record = userRates.value[index].split('|')
                    if (parseInt(record[1]) === movieId) {
                        return [index, record[2]]
                    }
                }

                return [-1, -1]
            }

            function updateRate(movieId, rate) {
                let record = '611' + '|' + movieId + '|' + rate + '|' + '0' //  total 610 users, so the new user id is 944

                const index = getRate(movieId)[0];
                if (index > -1) {
                    userRates.value[index] = record;
                } else {
                    userRates.value.push(record);
                }
                document.cookie = "user_rates=" + userRates.value;
            }
            // ==== Movie Like Operation ====
            const userLikes = ref({{user_likes | tojson}}) // If this place shows error, please check the format: ref({{user_likes | tojson}})

            function updateLike(_movieId) {
                let movieId = _movieId.toString()
                const index = userLikes.value.indexOf(movieId);
                if (index > -1) {
                    userLikes.value.splice(index, 1);
                } else {
                    userLikes.value.push(movieId);
                }

                document.cookie = "user_likes=" + userLikes.value;

                reloadPage();
            }
            function inLikes(movieId) {
                return userLikes.value.includes(movieId.toString())
            }


            function reloadPage() {
                location.reload();
            }

            return {
                isLoading,
                isActivityNavBar,
                cleanAll,

                showGenres,
                genres,
                updateGenre,
                inGenres,
                saveGenres,

                showMovieRate,
                userRates,
                getRate,
                updateRate,

                userLikes,
                updateLike,
                inLikes,

                reloadPage,
            }
        }
    })

    // Reset the Vue delimiters and Mount it
    app.config.compilerOptions.delimiters = ['[[', ']]']
    app.mount('#app')

</script>
</body>
</html>